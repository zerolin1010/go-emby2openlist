# ============================================
# Nginx 视频服务配置 - 测试版（无鉴权，便于排查问题）
# ============================================

#---------------------------------------------
# 健康检查专用 server
#---------------------------------------------
server {
    listen 80;
    server_name gtm-health;

    location = /gtm-health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location / {
        return 403;
    }
}

#---------------------------------------------
# 视频服务 server - 无鉴权测试版
#---------------------------------------------
server {
    listen 8081 default_server;
    server_name _;

    # ============ CORS 配置 ============
    add_header 'Access-Control-Allow-Origin'  '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Range, Origin, Accept, Content-Type, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges' always;

    # ============ 媒体目录 1: /video/data ============
    location /video/data/ {
        alias /mnt/google/;

        # 调试信息
        add_header 'X-Debug-Path' 'Matched /video/data/' always;
        add_header 'X-Debug-Alias' '/mnt/google/' always;
        add_header 'Accept-Ranges' bytes always;

        # 自动索引（调试用，可以看到目录列表）
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        types {
            video/mp4            mp4;
            video/x-matroska     mkv;
            video/webm           webm;
            video/x-msvideo      avi;
            video/quicktime      mov;
            video/x-flv          flv;
            video/MP2T           ts;
            audio/mpeg           mp3;
            audio/x-flac         flac;
            audio/x-wav          wav;
            audio/aac            aac;
            audio/ogg            ogg;
        }

        # 性能优化
        gzip off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # 日志
        access_log /var/log/nginx/video_test_access.log  combined;
        error_log  /var/log/nginx/video_test_error.log   warn;
    }

    # ============ 媒体目录 2: /video/data1 ============
    location /video/data1/ {
        alias /mnt/google1/;
        add_header 'X-Debug-Path' 'Matched /video/data1/' always;
        add_header 'Accept-Ranges' bytes always;
        autoindex on;

        types {
            video/mp4 mp4;
            video/x-matroska mkv;
        }

        gzip off;
        sendfile on;
        access_log /var/log/nginx/video_test_access.log  combined;
        error_log  /var/log/nginx/video_test_error.log   warn;
    }

    # ============ 测试根路径 ============
    location / {
        default_type application/json;
        return 200 '{"status":"ok","message":"Video gateway test server","paths":["/video/data/","/video/data1/"]}';
    }
}
