# ============================================
# Nginx 视频服务配置 - 方案1: 应用层签名临时 URL
# ============================================
#
# 工作流程:
# 1. 用户请求: GET /video/data/Movie/xxx.mkv?api_key=xxx
# 2. Nginx 代理到鉴权服务: http://go-emby2openlist:8097/api/video-auth/data/Movie/xxx.mkv?api_key=xxx
# 3. 鉴权服务验证 api_key，返回 302 重定向: /internal/data/Movie/xxx.mkv?token=xxx&expires=xxx&uid=xxx
# 4. Nginx 拦截 /internal/ 路径，使用 auth_request 验证 token
# 5. 鉴权服务验证 token 签名和过期时间，记录下载日志
# 6. Nginx 提供文件内容
#
# 安全特性:
# - HMAC-SHA256 签名，防止伪造
# - 5 分钟过期时间，限制分享
# - UID 追踪用户身份，便于封禁
# - 完整的访问和下载日志
# ============================================

#---------------------------------------------
# 健康检查专用 server
#---------------------------------------------
server {
    listen 80;
    server_name gtm-health;

    location = /gtm-health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location / {
        return 403;
    }
}

#---------------------------------------------
# 视频服务 server - 应用层签名方案
#---------------------------------------------
server {
    listen 7777 default_server;
    server_name _;

    # ============ CORS 配置 ============
    add_header 'Access-Control-Allow-Origin'  '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Range, Origin, Accept, Content-Type, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges' always;

    # ============ 公开访问路径：代理到鉴权服务 ============
    # 用户访问此路径时，Nginx 会将请求代理到 Go 应用的鉴权服务
    # 鉴权服务会验证 api_key，并返回 302 重定向到 /internal/ 路径
    location ~ ^/video/(data|data1|data2|data3|data4|data5|data6)/(.*)$ {
        # 提取路径参数
        set $media_type $1;  # data, data1, data2, ...
        set $file_path $2;   # Movie/xxx.mkv

        # 提取 api_key 参数
        set $api_key '';
        if ($arg_api_key != '') {
            set $api_key $arg_api_key;
        }

        # 代理到鉴权服务
        proxy_pass http://go-emby2openlist:8097/api/video-auth/$media_type/$file_path?api_key=$api_key;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 跟随 302 重定向（重定向到 /internal/ 路径）
        proxy_intercept_errors off;
        proxy_redirect default;

        # 日志
        access_log /var/log/nginx/video_public_access.log combined;
        error_log  /var/log/nginx/video_public_error.log warn;
    }

    # ============ 内部路径：需要 token 验证 ============
    # 只有通过鉴权服务签名的临时 URL 才能访问此路径
    location ~ ^/internal/(data|data1|data2|data3|data4|data5|data6)/(.*)$ {
        # 提取路径参数
        set $media_type $1;  # data, data1, data2, ...
        set $file_path $2;   # Movie/xxx.mkv

        # 使用 auth_request 验证 token
        auth_request /auth-verify;
        auth_request_set $auth_status $upstream_status;

        # 调试信息
        add_header 'X-Auth-Status' $auth_status always;
        add_header 'X-Media-Type' $media_type always;
        add_header 'Accept-Ranges' bytes always;

        # 根据 media_type 映射到实际的文件系统路径
        set $root_path '';
        if ($media_type = 'data') {
            set $root_path '/mnt/google';
        }
        if ($media_type = 'data1') {
            set $root_path '/mnt/google1';
        }
        if ($media_type = 'data2') {
            set $root_path '/mnt/google2';
        }
        if ($media_type = 'data3') {
            set $root_path '/mnt/google3';
        }
        if ($media_type = 'data4') {
            set $root_path '/mnt/google4';
        }
        if ($media_type = 'data5') {
            set $root_path '/mnt/google5';
        }
        if ($media_type = 'data6') {
            set $root_path '/mnt/google6';
        }

        # 提供文件内容
        alias $root_path/$file_path;

        # MIME 类型
        types {
            video/mp4            mp4;
            video/x-matroska     mkv;
            video/webm           webm;
            video/x-msvideo      avi;
            video/quicktime      mov;
            video/x-flv          flv;
            video/MP2T           ts;
            audio/mpeg           mp3;
            audio/x-flac         flac;
            audio/x-wav          wav;
            audio/aac            aac;
            audio/ogg            ogg;
        }

        # 性能优化
        gzip off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # 日志
        access_log /var/log/nginx/video_internal_access.log combined;
        error_log  /var/log/nginx/video_internal_error.log warn;
    }

    # ============ Token 验证接口（内部使用） ============
    location = /auth-verify {
        internal;  # 只能被内部调用

        # 代理到鉴权服务的 token 验证接口
        # 传递所有必需的参数：token, expires, uid, path
        proxy_pass http://go-emby2openlist:8097/api/verify-token?token=$arg_token&expires=$arg_expires&uid=$arg_uid&path=$uri;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ============ 根路径测试 ============
    location / {
        default_type application/json;
        return 200 '{"status":"ok","message":"Video gateway with signed URL auth","scheme":"application-layer"}';
    }
}
