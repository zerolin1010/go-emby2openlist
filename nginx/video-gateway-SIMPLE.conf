# ============================================
# Nginx 视频服务配置 - 简化方案（仅做文件服务）
# 鉴权由 Go 应用层的 api_key 验证完成
# ============================================

#---------------------------------------------
# 健康检查专用 server
#---------------------------------------------
server {
    listen 80;
    server_name gtm-health;

    location = /gtm-health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location / {
        return 403;
    }
}

#---------------------------------------------
# 视频服务 server - 简单文件服务
#---------------------------------------------
server {
    listen 7777 default_server;
    server_name _;

    # ============ CORS 配置 ============
    add_header 'Access-Control-Allow-Origin'  '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Range, Origin, Accept, Content-Type, Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range, Accept-Ranges' always;

    # ============ 媒体目录 ============
    location ~ ^/video/(data|data1|data2|data3|data4|data5|data6)/ {
        # 提取 media_type
        set $media_type $1;

        # 根据 media_type 映射到实际路径
        set $root_path '';
        if ($media_type = 'data') {
            set $root_path '/mnt/google';
        }
        if ($media_type = 'data1') {
            set $root_path '/mnt/google1';
        }
        if ($media_type = 'data2') {
            set $root_path '/mnt/google2';
        }
        if ($media_type = 'data3') {
            set $root_path '/mnt/google3';
        }
        if ($media_type = 'data4') {
            set $root_path '/mnt/google4';
        }
        if ($media_type = 'data5') {
            set $root_path '/mnt/google5';
        }
        if ($media_type = 'data6') {
            set $root_path '/mnt/google6';
        }

        # 重写路径，移除 /video/data 前缀
        rewrite ^/video/data(.*)$ $1 break;
        rewrite ^/video/data1(.*)$ $1 break;
        rewrite ^/video/data2(.*)$ $1 break;
        rewrite ^/video/data3(.*)$ $1 break;
        rewrite ^/video/data4(.*)$ $1 break;
        rewrite ^/video/data5(.*)$ $1 break;
        rewrite ^/video/data6(.*)$ $1 break;

        # 提供文件
        root $root_path;

        # 响应头
        add_header 'Accept-Ranges' bytes always;
        add_header 'X-Media-Path' $root_path always;

        # MIME 类型
        types {
            video/mp4            mp4;
            video/x-matroska     mkv;
            video/webm           webm;
            video/x-msvideo      avi;
            video/quicktime      mov;
            video/x-flv          flv;
            video/MP2T           ts;
            audio/mpeg           mp3;
            audio/x-flac         flac;
            audio/x-wav          wav;
            audio/aac            aac;
            audio/ogg            ogg;
        }

        # 性能优化
        gzip off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # 日志
        access_log /var/log/nginx/video_access.log combined;
        error_log  /var/log/nginx/video_error.log warn;
    }

    # ============ 根路径测试 ============
    location / {
        default_type application/json;
        return 200 '{"status":"ok","message":"Simple video gateway"}';
    }
}
